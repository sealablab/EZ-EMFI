--------------------------------------------------------------------------------
-- File: DS1140_PD_custom_inst_shim.vhd
-- Generated: 2025-11-03 00:53:15
-- Generator: tools/generate_custom_inst_v2.py
-- Template Version: 2.0 (BasicAppDataTypes)
--
-- ⚠️  GENERATED FILE - DO NOT EDIT MANUALLY ⚠️
-- This file is automatically generated from DS1140_PD_interface.yaml.
-- To modify, update the YAML file and regenerate.
--
-- Description:
--   Register mapping shim for DS1140_PD with BasicAppDataTypes.
--   Maps raw Control Registers (CR6-CR15) to typed application signals
--   using automatic register packing from BADRegisterMapper.
--
-- Platform: Moku:Go
-- Clock Frequency: 125 MHz
--
-- Register Mapping (best_fit strategy):
--   CR6: arm_timeout [31:16] | intensity [15:0]--   CR7: trigger_threshold [31:16] | cooling_duration [15:8] | firing_duration [7:0]--   CR8: arm_probe [31] | force_fire [30] | reset_fsm [29]--   Total: 3 registers, 67/96 bits (69.8% efficiency)
--
-- Architecture:
--   Layer 1: MCC_TOP_custom_inst_loader.vhd (static, shared)
--   Layer 2: DS1140_PD_custom_inst_shim.vhd (THIS FILE - generated)
--   Layer 3: DS1140_PD_custom_inst_main.vhd (application logic)
--
-- References:
--   - DS1140_PD_interface.yaml
--   - docs/BasicAppDataTypes/
--------------------------------------------------------------------------------

library IEEE;
use IEEE.std_logic_1164.all;
use IEEE.numeric_std.all;

library WORK;
use WORK.custom_inst_common_pkg.all;
use WORK.basic_app_types_pkg.all;
use WORK.basic_app_voltage_pkg.all;
use WORK.basic_app_time_pkg.all;
entity DS1140_PD_custom_inst_shim is
    generic (
        CLK_FREQ_HZ : integer := 125000000  -- Moku:Go clock frequency
    );
    port (
        ------------------------------------------------------------------------
        -- Clock and Reset
        ------------------------------------------------------------------------
        Clk         : in  std_logic;
        Reset       : in  std_logic;  -- Active-high reset

        ------------------------------------------------------------------------
        -- VOLO Control Signals (from MCC_TOP_custom_inst_loader)
        ------------------------------------------------------------------------
        volo_ready  : in  std_logic;  -- CR0[31] - Set by loader
        user_enable : in  std_logic;  -- CR0[30] - User control
        clk_enable  : in  std_logic;  -- CR0[29] - Clock gating
        loader_done : in  std_logic;  -- BRAM loader FSM done signal

        ------------------------------------------------------------------------
        -- Handshaking Protocol
        ------------------------------------------------------------------------
        ready_for_updates : in  std_logic;  -- From main application

        ------------------------------------------------------------------------
        -- Application Registers (from MCC_TOP_custom_inst_loader)
        -- Control Registers CR6-CR15
        ------------------------------------------------------------------------
        app_reg_6 : in  std_logic_vector(31 downto 0);        app_reg_7 : in  std_logic_vector(31 downto 0);        app_reg_8 : in  std_logic_vector(31 downto 0)    );
end entity DS1140_PD_custom_inst_shim;

architecture rtl of DS1140_PD_custom_inst_shim is

    ----------------------------------------------------------------------------
    -- Typed Signal Declarations (BasicAppDataTypes)
    ----------------------------------------------------------------------------
    signal arm_probe : std_logic;  -- Arm the probe driver (one-shot operation)
    signal force_fire : std_logic;  -- Manual trigger for testing (bypasses threshold detection)
    signal reset_fsm : std_logic;  -- Reset state machine to READY state
    signal arm_timeout : unsigned(15 downto 0);  -- Maximum time in armed state before timeout
    signal firing_duration : unsigned(7 downto 0);  -- FSM duration in FIRING state (NOT EM pulse - that's hardware-fixed at 50ns)
    signal cooling_duration : unsigned(7 downto 0);  -- FSM duration in COOLING state (thermal recovery period)
    signal trigger_threshold : signed(15 downto 0);  -- Voltage threshold for trigger detection (Moku Go/Lab/Pro: ±25V ADC range)
    signal intensity : signed(15 downto 0);  -- Pulse amplitude control (0-3.3V to DS1120A, hardware clamped at probe)

    ----------------------------------------------------------------------------
    -- Global Enable Signal
    ----------------------------------------------------------------------------
    signal global_enable : std_logic;

begin

    ----------------------------------------------------------------------------
    -- Global Enable Computation
    ----------------------------------------------------------------------------
    global_enable <= combine_volo_ready(volo_ready, user_enable, clk_enable, loader_done);

    ----------------------------------------------------------------------------
    -- Atomic Register Update Process
    --
    -- Extracts typed values from packed registers on rising_edge when
    -- ready_for_updates='1'. Type conversions use frozen VHDL packages.
    ----------------------------------------------------------------------------
    REGISTER_UPDATE_PROC: process(Clk)
    begin
        if rising_edge(Clk) then
            if Reset = '1' then
                -- Load default values from YAML specification
                arm_probe <= '0';  -- Arm the probe driver (one-shot operation)
                force_fire <= '0';  -- Manual trigger for testing (bypasses threshold detection)
                reset_fsm <= '0';  -- Reset state machine to READY state
                arm_timeout <= to_unsigned(1000, 16);  -- Maximum time in armed state before timeout
                firing_duration <= to_unsigned(128, 8);  -- FSM duration in FIRING state (NOT EM pulse - that's hardware-fixed at 50ns)
                cooling_duration <= to_unsigned(128, 8);  -- FSM duration in COOLING state (thermal recovery period)
                trigger_threshold <= to_signed(2400, 16);  -- Voltage threshold for trigger detection (Moku Go/Lab/Pro: ±25V ADC range)
                intensity <= to_signed(2000, 16);  -- Pulse amplitude control (0-3.3V to DS1120A, hardware clamped at probe)
            elsif ready_for_updates = '1' then
                -- Atomic update: Extract all typed values from packed registers
                arm_probe <= app_reg_8(31);  -- Arm the probe driver (one-shot operation)
                force_fire <= app_reg_8(30);  -- Manual trigger for testing (bypasses threshold detection)
                reset_fsm <= app_reg_8(29);  -- Reset state machine to READY state
                arm_timeout <= unsigned(app_reg_6((31 downto 16)));  -- Maximum time in armed state before timeout (raw time value)
                firing_duration <= unsigned(app_reg_7((7 downto 0)));  -- FSM duration in FIRING state (NOT EM pulse - that's hardware-fixed at 50ns) (raw time value)
                cooling_duration <= unsigned(app_reg_7((15 downto 8)));  -- FSM duration in COOLING state (thermal recovery period) (raw time value)
                trigger_threshold <= voltage_input_25v_s16_from_raw(app_reg_7((31 downto 16)));  -- Voltage threshold for trigger detection (Moku Go/Lab/Pro: ±25V ADC range)
                intensity <= voltage_output_05v_s16_from_raw(app_reg_6((15 downto 0)));  -- Pulse amplitude control (0-3.3V to DS1120A, hardware clamped at probe)
            end if;
        end if;
    end process REGISTER_UPDATE_PROC;

    ----------------------------------------------------------------------------
    -- Main Application Instantiation
    ----------------------------------------------------------------------------
    MAIN_INST: entity WORK.DS1140_PD_custom_inst_main
        generic map (
            CLK_FREQ_HZ => CLK_FREQ_HZ
        )
        port map (
            Clk                => Clk,
            Reset              => Reset,
            global_enable      => global_enable,
            ready_for_updates  => open,  -- Driven by main, connected here

            -- Application signals (typed)
            arm_probe => arm_probe,            force_fire => force_fire,            reset_fsm => reset_fsm,            arm_timeout => arm_timeout,            firing_duration => firing_duration,            cooling_duration => cooling_duration,            trigger_threshold => trigger_threshold,            intensity => intensity        );

end architecture rtl;